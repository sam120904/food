{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div class="h-[calc(100vh-64px)] w-full flex bg-background-light dark:bg-black relative overflow-hidden">

    <!-- 1. Left Map Area -->
    <div class="flex-1 relative bg-[#e5e7eb] dark:bg-[#1f1f1f]">
        <!-- Search, Map, Zoom controls -->
        <div class="absolute top-6 left-6 z-[1000] w-80">
            <div
                class="flex items-center gap-3 bg-white dark:bg-zinc-800 px-4 py-3 rounded-xl shadow-lg border border-gray-100 dark:border-white/5">
                <button id="searchBtn"
                    class="material-symbols-outlined text-green-500 hover:text-green-600 transition-colors">search</button>
                <input id="searchInput" type="text" placeholder="Search area (e.g. Delhi)..."
                    class="w-full bg-transparent border-none p-0 text-sm font-bold focus:ring-0 placeholder-gray-400">
            </div>
        </div>

        <!-- Real Map Container -->
        <div id="foodMap" class="absolute inset-0 w-full h-full z-0"></div>

    </div>

    <!-- 2. Right Sidebar Listings -->
    <div
        class="w-[480px] bg-[#f9fafb] dark:bg-black border-l border-gray-200 dark:border-white/10 flex flex-col z-20 shadow-2xl">
        <div class="p-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-black dark:text-white">Urgent Listings</h2>
                <div
                    class="px-2 py-0.5 bg-red-100 text-red-600 text-[10px] font-black tracking-widest uppercase rounded flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Live
                </div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button
                    class="filter-btn active px-4 py-1.5 bg-[#13ec13] text-black text-xs font-bold rounded shadow-lg shadow-green-200 hover:scale-105 transition-transform"
                    data-filter="all">All</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="veg">Veg Only</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="non-veg">Non-Veg</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for listing in listings %}
            <!-- Card -->
            <div class="listing-card bg-white dark:bg-zinc-900 p-5 rounded-2xl shadow-sm border border-transparent hover:border-green-400 hover:shadow-md transition-all group"
                data-type="{{ listing.food_type }}"
                data-veg="{% if listing.food_type == 'packaged' %}non-veg{% else %}veg{% endif %}"
                data-lat="{{ listing.donor.latitude|default:0 }}" data-lng="{{ listing.donor.longitude|default:0 }}"
                data-id="{{ listing.id }}">

                <div class="flex justify-between mb-4">
                    <div class="flex gap-4">
                        <!-- Simplified IF logic for classes -->
                        {% if listing.food_type == 'packaged' %}
                        <div class="size-12 rounded-xl bg-red-50 text-red-500 flex items-center justify-center">
                            {% else %}
                            <div class="size-12 rounded-xl bg-green-50 text-green-600 flex items-center justify-center">
                                {% endif %}
                                <span class="material-symbols-outlined">
                                    {% if listing.food_type == 'cooked' %}
                                    restaurant
                                    {% elif listing.food_type == 'raw' %}
                                    grocery
                                    {% else %}
                                    takeout_dining
                                    {% endif %}
                                </span>
                            </div>

                            <div>
                                <h3 class="font-bold text-black dark:text-white text-base leading-tight">
                                    {{ listing.description|truncatechars:25 }}
                                </h3>
                                <p class="text-xs text-gray-400 mt-0.5">
                                    {{ listing.donor.institution_name|default:listing.donor.username }}
                                </p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-green-600">0.8 km away</span>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Quantity</p>
                            <p class="text-sm font-black text-black dark:text-white">{{ listing.quantity_kg }} kg</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Expires In</p>
                            <p class="text-sm font-black text-orange-500">{{ listing.expiry_time|timeuntil }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Rating</p>
                            <div class="flex items-center gap-1">
                                <span class="text-sm font-black text-black dark:text-white">
                                    {{ listing.donor.trust_score|default:"5.0" }}
                                </span>
                                <span class="material-symbols-outlined text-[10px] text-yellow-400">star</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    {% if listing.id in pending_claim_ids %}
                    <button disabled
                        class="block w-full py-3 bg-gray-100 dark:bg-zinc-800 text-gray-400 font-black text-center text-sm rounded-lg cursor-not-allowed">
                        Waiting for Approval
                    </button>
                    {% else %}
                    <a href="{% url 'claim_listing' listing.id %}"
                        class="block w-full py-3 bg-[#13ec13] text-black font-black text-center text-sm rounded-lg hover:brightness-105 active:scale-[0.98] transition-all">
                        Claim Now
                    </a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-10 opacity-50">
                    <p>No listings available right now.</p>
                </div>
                {% endfor %}

                <button
                    class="w-full py-4 text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest border-t border-gray-100 dark:border-white/5 mt-4">
                    View More Listings
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Map
        // Default to Bangalore (12.9716, 77.5946) if no location
        var map = L.map('foodMap').setView([12.9716, 77.5946], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var markers = [];

        // Add markers from listings
        {% for listing in listings %}
        {% if listing.donor.latitude and listing.donor.longitude %}
        var lat = {{ listing.donor.latitude }};
        var lng = {{ listing.donor.longitude }};
        var title = "{{ listing.description|escapejs }}";
        var donor = "{{ listing.donor.institution_name|default:listing.donor.username|escapejs }}";
        var quantity = "{{ listing.quantity_kg }}";

        var markerIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#13ec13; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);'><span class='material-symbols-outlined' style='font-size:18px; color:black;'>restaurant</span></div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        var marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);

        var popupContent = `
                    <div class="font-sans">
                        <h3 class="font-bold text-sm mb-1">${title}</h3>
                        <p class="text-xs text-gray-600 mb-1">by ${donor}</p>
                        <p class="text-xs font-bold text-green-600">${quantity} kg available</p>
                    </div>
                `;

        marker.bindPopup(popupContent);
        markers.push(marker);
        {% endif %}
        {% endfor %}

        // Filter Logic
        const btns = document.querySelectorAll('.filter-btn');
        const cards = document.querySelectorAll('.listing-card');

        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                btns.forEach(b => {
                    b.classList.remove('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');
                    b.classList.add('bg-white', 'text-gray-600', 'border');
                });
                btn.classList.remove('bg-white', 'text-gray-600', 'border');
                btn.classList.add('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');

                const filter = btn.dataset.filter;
                cards.forEach(c => {
                    if (filter === 'all') c.style.display = 'block';
                    else c.style.display = (c.dataset.veg === filter) ? 'block' : 'none';
                });
            });
        });

        // Interaction between cards and map
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                const lat = card.dataset.lat;
                const lng = card.dataset.lng;
                if (lat && lng && lat != 0 && lng != 0) {
                    map.flyTo([lat, lng], 15, {
                        animate: true,
                        duration: 0.5
                    });
                }
            });
        });

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        async function searchLocation() {
            const query = searchInput.value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.flyTo([lat, lon], 12);
                } else {
                    alert('Location not found');
                }
            } catch (error) {
                console.error('Error searching location:', error);
                alert('Error searching location');
            }
        }

        searchBtn.addEventListener('click', searchLocation);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
    </script>
    <style>
        /* Fix for Leaflet z-index issues with sidebar */
        .leaflet-pane {
            z-index: 0 !important;
        }

        .leaflet-control {
            z-index: 10 !important;
        }

        .leaflet-top,
        .leaflet-bottom {
            z-index: 10 !important;
        }
    </style>
    {% endblock %}