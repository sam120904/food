{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- ========== VOLUNTEER SECTION ========== -->
<div class="bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-white/10">
    <div class="max-w-[1400px] mx-auto px-6 py-5">
        <!-- Header Row -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">groups</span>
                </div>
                <div>
                    <h2 class="text-lg font-black text-black dark:text-white">Our Volunteers</h2>
                    <p class="text-xs text-gray-400">Manage your team of food heroes</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Stats Pills -->
                <div class="flex gap-2">
                    <span
                        class="px-3 py-1.5 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs font-bold rounded-full flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        {{ active_volunteers }} Active
                    </span>
                    <span
                        class="px-3 py-1.5 bg-gray-100 dark:bg-zinc-800 text-gray-600 dark:text-gray-400 text-xs font-bold rounded-full">
                        {{ total_volunteers }} Total
                    </span>
                </div>
                <!-- Add Volunteer Button -->
                <button onclick="toggleAddForm()" id="btn-add-volunteer"
                    class="flex items-center gap-1.5 px-4 py-1.5 text-xs font-bold text-white bg-primary hover:brightness-110 rounded-lg transition-all shadow-sm shadow-primary/20">
                    <span class="material-symbols-outlined text-sm">person_add</span>
                    Add Volunteer
                </button>
                <!-- Toggle Button -->
                <button onclick="toggleVolunteerSection()" id="toggle-volunteers-btn"
                    class="flex items-center gap-1 px-3 py-1.5 text-xs font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 bg-gray-100 dark:bg-zinc-800 rounded-lg transition-colors">
                    <span class="material-symbols-outlined text-sm" id="toggle-icon">expand_more</span>
                    <span id="toggle-text">Show</span>
                </button>
            </div>
        </div>

        <!-- Volunteer Table (Collapsible) -->
        <div id="volunteer-section" class="hidden animate-fade-in">
            {% if volunteers %}
            <div class="overflow-x-auto rounded-xl border border-gray-200 dark:border-zinc-700">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-zinc-800 text-left">
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Volunteer
                                ID</th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Name</th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Phone
                            </th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Email
                            </th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Address
                            </th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Status
                            </th>
                            <th class="px-4 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-400">Joined
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-zinc-800">
                        {% for v in vol_list %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-zinc-800/50 transition-colors">
                            <td class="px-4 py-3">
                                <span
                                    class="font-mono text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded">{{v.vid}}</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div
                                        class="size-7 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold">
                                        {{v.initial}}
                                    </div>
                                    <span class="font-bold text-black dark:text-white">{{v.name}}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-gray-600 dark:text-gray-400">{{v.phone}}</td>
                            <td class="px-4 py-3 text-gray-600 dark:text-gray-400">{{v.email}}</td>
                            <td class="px-4 py-3 text-gray-600 dark:text-gray-400 max-w-[150px] truncate">{{v.addr}}
                            </td>
                            <td class="px-4 py-3">
                                {% if v.status == 'active' %}
                                <span
                                    class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                                    <span class="w-1 h-1 rounded-full bg-green-500"></span> Active
                                </span>
                                {% else %}
                                <span
                                    class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 dark:bg-zinc-700 text-gray-500">
                                    <span class="w-1 h-1 rounded-full bg-gray-400"></span> Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-400">{{v.joined|date:"M d, Y"}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8 border border-dashed border-gray-200 dark:border-zinc-700 rounded-xl">
                <div
                    class="size-14 bg-gray-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="material-symbols-outlined text-2xl text-gray-400">person_add</span>
                </div>
                <p class="font-bold text-gray-500 dark:text-gray-400 text-sm">No volunteers yet</p>
                <p class="text-xs text-gray-400 mt-1">Click "Add Volunteer" above to add your first volunteer.</p>
            </div>
            {% endif %}

            <!-- Add Volunteer Inline Form -->
            <div id="add-volunteer-form"
                class="hidden mt-4 p-5 rounded-xl border border-primary/30 bg-green-50/50 dark:bg-green-900/10 animate-fade-in">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-primary">person_add</span>
                    <h3 class="font-bold text-sm text-black dark:text-white">Add New Volunteer</h3>
                </div>
                <form method="post" action="{% url 'add_volunteer' %}">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase tracking-wider text-gray-400">Name *</label>
                            <input type="text" name="name" required
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                placeholder="Volunteer name">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase tracking-wider text-gray-400">Phone</label>
                            <input type="text" name="phone"
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                placeholder="Phone number">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase tracking-wider text-gray-400">Email</label>
                            <input type="email" name="email"
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                placeholder="email@example.com">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase tracking-wider text-gray-400">Address</label>
                            <input type="text" name="address"
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                                placeholder="Full address">
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-3 mt-4">
                        <button type="button" onclick="toggleAddForm()"
                            class="px-4 py-2 text-xs font-bold text-gray-500 hover:text-gray-700 bg-gray-100 dark:bg-zinc-800 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex items-center gap-1.5 px-5 py-2 text-xs font-bold text-black bg-primary hover:brightness-110 rounded-lg transition-all shadow-sm shadow-primary/20">
                            <span class="material-symbols-outlined text-sm">check</span>
                            Save Volunteer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleVolunteerSection() {
        const section = document.getElementById('volunteer-section');
        const icon = document.getElementById('toggle-icon');
        const text = document.getElementById('toggle-text');

        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.textContent = 'expand_less';
            text.textContent = 'Hide';
        } else {
            section.classList.add('hidden');
            icon.textContent = 'expand_more';
            text.textContent = 'Show';
        }
    }

    function toggleAddForm() {
        const form = document.getElementById('add-volunteer-form');
        const section = document.getElementById('volunteer-section');
        const icon = document.getElementById('toggle-icon');
        const text = document.getElementById('toggle-text');

        // Always show the volunteer section when opening the form
        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.textContent = 'expand_less';
            text.textContent = 'Hide';
        }

        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            form.querySelector('input[name="name"]').focus();
        }
    }
</script>
<!-- ========== END VOLUNTEER SECTION ========== -->

<!-- ========== CLAIMS MANAGER ========== -->
<div class="bg-white dark:bg-zinc-900 border-b border-gray-200 dark:border-white/10">
    <div class="max-w-[1400px] mx-auto px-6 py-5">
        <div class="flex items-center gap-3 mb-6">
            <div class="size-10 rounded-xl bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center">
                <span class="material-symbols-outlined text-orange-600 dark:text-orange-400">task_alt</span>
            </div>
            <div>
                <h2 class="text-lg font-black text-black dark:text-white">Claims Manager</h2>
                <p class="text-xs text-gray-400">Track and assign volunteers to your claims</p>
            </div>
        </div>

        {% if not unassigned_claims and not assigned_pickup_tasks and not pending_claims %}
        <div class="text-center py-8 border border-dashed border-gray-200 dark:border-zinc-700 rounded-xl">
            <div
                class="size-14 bg-gray-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-3">
                <span class="material-symbols-outlined text-2xl text-gray-400">inbox</span>
            </div>
            <p class="font-bold text-gray-500 dark:text-gray-400 text-sm">No active claims</p>
            <p class="text-xs text-gray-400 mt-1">Claim listing from the map to see them here.</p>
        </div>
        {% endif %}

        <div class="space-y-6">
            <!-- 1. ACTION REQUIRED: Unassigned Claims -->
            {% if unassigned_list %}
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <span
                        class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] font-black uppercase tracking-wider rounded">Action
                        Required</span>
                    <h3 class="text-sm font-bold text-black dark:text-white">Ready for Assignment</h3>
                </div>
                <div class="space-y-3">
                    {% for c in unassigned_list %}
                    <div
                        class="p-4 rounded-xl border border-red-200 dark:border-red-900/50 bg-red-50/50 dark:bg-red-900/10 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div
                                class="size-10 rounded-xl bg-white dark:bg-zinc-800 shadow-sm flex items-center justify-center">
                                <span class="material-symbols-outlined text-red-500">priority_high</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-black dark:text-white text-sm">{{c.desc|truncatechars:35}}
                                </h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{c.donor_name}} · {{c.qty}} kg</p>
                            </div>
                        </div>
                        <form method="post" action="{% url 'assign_volunteer' c.id %}"
                            class="flex items-center gap-2 w-full md:w-auto">
                            {% csrf_token %}
                            <select name="volunteer_id" required
                                class="flex-1 md:w-48 px-3 py-2 text-xs font-bold rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                <option value="">Select Volunteer</option>
                                {% for vol in active_volunteers_list %}
                                <option value="{{ vol.id }}">{{ vol.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit"
                                class="whitespace-nowrap flex items-center gap-1.5 px-4 py-2 text-xs font-bold text-white bg-primary hover:brightness-110 rounded-lg transition-all shadow-sm shadow-primary/20">
                                Assign
                                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- 2. IN PROGRESS: Assigned Claims -->
            {% if assigned_tasks_list %}
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <span
                        class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-black uppercase tracking-wider rounded">In
                        Progress</span>
                    <h3 class="text-sm font-bold text-black dark:text-white">Assigned Pickups</h3>
                </div>
                <div class="space-y-3">
                    {% for t in assigned_tasks_list %}
                    <div
                        class="p-4 rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800/50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center gap-3 flex-1">
                            <div
                                class="size-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center">
                                <span
                                    class="material-symbols-outlined text-blue-600 dark:text-blue-400">local_shipping</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-black dark:text-white text-sm">{{t.desc|truncatechars:35}}
                                </h3>
                                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <span class="flex items-center gap-1">
                                        <span class="material-symbols-outlined text-[10px]">person</span>
                                        {{t.vname}}
                                    </span>
                                    <span>•</span>
                                    <span>Assigned {{t.assigntime|timesince}} ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span
                                class="px-3 py-1 bg-gray-100 dark:bg-zinc-700 text-gray-600 dark:text-gray-300 text-xs font-bold rounded-full">
                                {{t.status_display}}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- 3. PENDING: Waitlist -->
            {% if pending_list %}
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <span
                        class="px-2 py-0.5 bg-gray-100 text-gray-600 text-[10px] font-black uppercase tracking-wider rounded">Waitlist</span>
                    <h3 class="text-sm font-bold text-black dark:text-white">Pending Approval</h3>
                </div>
                <div class="space-y-3">
                    {% for p in pending_list %}
                    <div
                        class="p-4 rounded-xl border border-dashed border-gray-200 dark:border-zinc-700 bg-gray-50/50 dark:bg-zinc-800/30 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="size-10 rounded-xl bg-gray-100 dark:bg-zinc-700 flex items-center justify-center">
                                <span class="material-symbols-outlined text-gray-400">hourglass_empty</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-600 dark:text-gray-400 text-sm">
                                    {{p.desc|truncatechars:35}}</h3>
                                <p class="text-xs text-gray-400">Waiting for donor approval</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- ========== END ASSIGN PICKUPS SECTION ========== -->

<div class="h-[calc(100vh-64px)] w-full flex bg-background-light dark:bg-black relative overflow-hidden">

    <!-- 1. Left Map Area -->
    <div class="flex-1 relative bg-[#e5e7eb] dark:bg-[#1f1f1f]">
        <!-- Search, Map, Zoom controls -->
        <div class="absolute top-6 left-6 z-[1000] w-80">
            <div
                class="flex items-center gap-3 bg-white dark:bg-zinc-800 px-4 py-3 rounded-xl shadow-lg border border-gray-100 dark:border-white/5">
                <button id="searchBtn"
                    class="material-symbols-outlined text-green-500 hover:text-green-600 transition-colors">search</button>
                <input id="searchInput" type="text" placeholder="Search area (e.g. Delhi)..."
                    class="w-full bg-transparent border-none p-0 text-sm font-bold focus:ring-0 placeholder-gray-400">
            </div>
        </div>

        <!-- Real Map Container -->
        <div id="foodMap" class="absolute inset-0 w-full h-full z-0"></div>

    </div>

    <!-- 2. Right Sidebar Listings -->
    <div
        class="w-[480px] bg-[#f9fafb] dark:bg-black border-l border-gray-200 dark:border-white/10 flex flex-col z-20 shadow-2xl">
        <div class="p-6 pb-2">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-black dark:text-white">Urgent Listings</h2>
                <div
                    class="px-2 py-0.5 bg-red-100 text-red-600 text-[10px] font-black tracking-widest uppercase rounded flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Live
                </div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button
                    class="filter-btn active px-4 py-1.5 bg-[#13ec13] text-black text-xs font-bold rounded shadow-lg shadow-green-200 hover:scale-105 transition-transform"
                    data-filter="all">All</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="veg">Veg Only</button>
                <button
                    class="filter-btn px-4 py-1.5 bg-white border border-gray-200 text-gray-600 text-xs font-bold rounded hover:border-green-500 transition-colors"
                    data-filter="non-veg">Non-Veg</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for listing in listings %}
            <!-- Card -->
            <div class="listing-card bg-white dark:bg-zinc-900 p-5 rounded-2xl shadow-sm border border-transparent hover:border-green-400 hover:shadow-md transition-all group"
                data-type="{{ listing.food_type }}"
                data-veg="{% if listing.food_type == 'packaged' %}non-veg{% else %}veg{% endif %}"
                data-lat="{{ listing.donor.latitude|default:0 }}" data-lng="{{ listing.donor.longitude|default:0 }}"
                data-id="{{ listing.id }}">

                <div class="flex justify-between mb-4">
                    <div class="flex gap-4">
                        <!-- Simplified IF logic for classes -->
                        {% if listing.food_type == 'packaged' %}
                        <div class="size-12 rounded-xl bg-red-50 text-red-500 flex items-center justify-center">
                            {% else %}
                            <div class="size-12 rounded-xl bg-green-50 text-green-600 flex items-center justify-center">
                                {% endif %}
                                <span class="material-symbols-outlined">
                                    {% if listing.food_type == 'cooked' %}
                                    restaurant
                                    {% elif listing.food_type == 'raw' %}
                                    grocery
                                    {% else %}
                                    takeout_dining
                                    {% endif %}
                                </span>
                            </div>

                            <div>
                                <h3 class="font-bold text-black dark:text-white text-base leading-tight">
                                    {{ listing.description|truncatechars:25 }}
                                </h3>
                                <p class="text-xs text-gray-400 mt-0.5">
                                    {{ listing.donor.institution_name|default:listing.donor.username }}
                                </p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-green-600">0.8 km away</span>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-2 mb-5">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Quantity</p>
                            <p class="text-sm font-black text-black dark:text-white">{{ listing.quantity_kg }} kg</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Expires In</p>
                            <p class="text-sm font-black text-orange-500">{{ listing.expiry_time|timeuntil }}</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Rating</p>
                            <div class="flex items-center gap-1">
                                <span class="text-sm font-black text-black dark:text-white">
                                    {{ listing.donor.trust_score|default:"5.0" }}
                                </span>
                                <span class="material-symbols-outlined text-[10px] text-yellow-400">star</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    {% if listing.id in pending_claim_ids %}
                    <button disabled
                        class="block w-full py-3 bg-gray-100 dark:bg-zinc-800 text-gray-400 font-black text-center text-sm rounded-lg cursor-not-allowed">
                        Waiting for Approval
                    </button>
                    {% else %}
                    <a href="{% url 'claim_listing' listing.id %}"
                        class="block w-full py-3 bg-[#13ec13] text-black font-black text-center text-sm rounded-lg hover:brightness-105 active:scale-[0.98] transition-all">
                        Claim Now
                    </a>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center py-10 opacity-50">
                    <p>No listings available right now.</p>
                </div>
                {% endfor %}

                <button
                    class="w-full py-4 text-xs font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest border-t border-gray-100 dark:border-white/5 mt-4">
                    View More Listings
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Map
        // Default to Bangalore (12.9716, 77.5946) if no location
        var map = L.map('foodMap').setView([12.9716, 77.5946], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        var markers = [];

        // Add markers from listings
        {% for listing in listings %}
        {% if listing.donor.latitude and listing.donor.longitude %}
        var lat = {{ listing.donor.latitude }};
        var lng = {{ listing.donor.longitude }};
        var title = "{{ listing.description|escapejs }}";
        var donor = "{{ listing.donor.institution_name|default:listing.donor.username|escapejs }}";
        var quantity = "{{ listing.quantity_kg }}";

        var markerIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#13ec13; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);'><span class='material-symbols-outlined' style='font-size:18px; color:black;'>restaurant</span></div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        var marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);

        var popupContent = `
                    <div class="font-sans">
                        <h3 class="font-bold text-sm mb-1">${title}</h3>
                        <p class="text-xs text-gray-600 mb-1">by ${donor}</p>
                        <p class="text-xs font-bold text-green-600">${quantity} kg available</p>
                    </div>
                `;

        marker.bindPopup(popupContent);
        markers.push(marker);
        {% endif %}
        {% endfor %}

        // Filter Logic
        const btns = document.querySelectorAll('.filter-btn');
        const cards = document.querySelectorAll('.listing-card');

        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                btns.forEach(b => {
                    b.classList.remove('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');
                    b.classList.add('bg-white', 'text-gray-600', 'border');
                });
                btn.classList.remove('bg-white', 'text-gray-600', 'border');
                btn.classList.add('bg-[#13ec13]', 'text-black', 'shadow-lg', 'shadow-green-200');

                const filter = btn.dataset.filter;
                cards.forEach(c => {
                    if (filter === 'all') c.style.display = 'block';
                    else c.style.display = (c.dataset.veg === filter) ? 'block' : 'none';
                });
            });
        });

        // Interaction between cards and map
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                const lat = card.dataset.lat;
                const lng = card.dataset.lng;
                if (lat && lng && lat != 0 && lng != 0) {
                    map.flyTo([lat, lng], 15, {
                        animate: true,
                        duration: 0.5
                    });
                }
            });
        });

        // Search Functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        async function searchLocation() {
            const query = searchInput.value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.flyTo([lat, lon], 12);
                } else {
                    alert('Location not found');
                }
            } catch (error) {
                console.error('Error searching location:', error);
                alert('Error searching location');
            }
        }

        searchBtn.addEventListener('click', searchLocation);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
    </script>
    <style>
        /* Fix for Leaflet z-index issues with sidebar */
        .leaflet-pane {
            z-index: 0 !important;
        }

        .leaflet-control {
            z-index: 10 !important;
        }

        .leaflet-top,
        .leaflet-bottom {
            z-index: 10 !important;
        }
    </style>
    {% endblock %}